#!/usr/bin/env bash
set -euo pipefail

# Default interface
readonly DEFAULT_INTERFACE="wlan0"

# Color codes for output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly NC='\033[0m' # No Color

# Logging functions
log_info() {
	echo -e "${GREEN}[INFO]${NC} $*" >&2
}

log_error() {
	echo -e "${RED}[ERROR]${NC} $*" >&2
}

show_usage() {
	cat >&2 <<-EOF
		Usage: $0 [-i <interface>] <subdomain>

		Options:
		  -i <interface>  Network interface to use (default: $DEFAULT_INTERFACE)
		  -h              Show this help message

		Arguments:
		  <subdomain>     Subdomain to publish
	EOF
}

check_dependencies() {
	local missing_deps=()
	local required_commands=("avahi-publish" "ip")

	for cmd in "${required_commands[@]}"; do
		if ! command -v "$cmd" &>/dev/null; then
			missing_deps+=("$cmd")
		fi
	done

	if [[ ${#missing_deps[@]} -gt 0 ]]; then
		log_error "Missing required dependencies: ${missing_deps[*]}"
		exit 1
	fi
}

validate_interface() {
	local interface="$1"

	if ! ip link show "$interface" &>/dev/null; then
		log_error "Network interface '$interface' not found."
		log_error "Available interfaces:"
		ip link show | grep -E '^[0-9]+:' | awk -F': ' '{print "  " $2}' | sed 's/@.*//' >&2
		exit 1
	fi
}

get_interface_addresses() {
	local interface="$1"

	local ipv4_addresses=$(ip -4 -o addr show dev "$interface" scope global | awk '{print $4}' | cut -d/ -f1)

	# Check if we have IPv4 addresses
	if [[ -z "$ipv4_addresses" ]]; then
		log_error "No IPv4 addresses found on interface '$interface'."
		exit 1
	fi

	local ipv6_addresses=$(ip -6 -o addr show dev "$interface" scope global | awk '{print $4}' | cut -d/ -f1)

	# Check if we have IPv6 addresses
	if [[ -z "$ipv6_addresses" ]]; then
		log_error "No IPv6 addresses found on interface '$interface'."
		exit 1
	fi

	# Combine IPv4 and IPv6 addresses
	local all_addresses="$ipv4_addresses"$'\n'"$ipv6_addresses"

	echo "$all_addresses"
}

publish_addresses() {
	local fqdn="$1"
	local addresses="$2"

	log_info "Publishing '$fqdn' with addresses:"

	for addr in $addresses; do
		log_info "  $addr"
		avahi-publish -f -a -R "$fqdn" "$addr" &
	done

	# Wait for all background processes
	wait
}

main() {
	local interface="$DEFAULT_INTERFACE"

	# Parse command line options
	while getopts ":i:h" opt; do
		case "$opt" in
		i) interface="$OPTARG" ;;
		h)
			show_usage
			exit 0
			;;
		\?)
			log_error "Invalid option -$OPTARG"
			show_usage
			exit 1
			;;
		:)
			log_error "Option -$OPTARG requires an argument"
			show_usage
			exit 1
			;;
		esac
	done
	shift $((OPTIND - 1))

	# Validate arguments
	if [[ $# -ne 1 ]]; then
		log_error "Exactly one subdomain argument is required."
		show_usage
		exit 1
	fi

	local subdomain="$1"
	local fqdn="${subdomain}.$(hostname).local"

	# Check dependencies
	check_dependencies

	# Validate interface
	validate_interface "$interface"

	# Get addresses
	local addresses=$(get_interface_addresses "$interface")

	# Publish addresses
	publish_addresses "$fqdn" "$addresses"
}

main "$@"
