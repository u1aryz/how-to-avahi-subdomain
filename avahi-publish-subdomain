#!/usr/bin/env bash
set -euo pipefail

# Default interface
readonly DEFAULT_INTERFACE="wlan0"

# Color codes for output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly NC='\033[0m' # No Color

# Logging functions
log_info() {
	echo -e "${GREEN}[INFO]${NC} $*" >&2
}

log_error() {
	echo -e "${RED}[ERROR]${NC} $*" >&2
}

show_usage() {
	cat >&2 <<-EOF
		Usage: $0 [-i <interface>] <subdomain>

		Options:
		  -i <interface>  Network interface to use (default: $DEFAULT_INTERFACE)
		  -h              Show this help message

		Arguments:
		  <subdomain>     Subdomain to publish
	EOF
}

check_dependencies() {
	local missing_deps=()

	if ! command -v avahi-publish >/dev/null 2>&1; then
		missing_deps+=("avahi-publish")
	fi

	if ! command -v ip >/dev/null 2>&1; then
		missing_deps+=("ip")
	fi

	if [[ ${#missing_deps[@]} -gt 0 ]]; then
		log_error "Missing required dependencies: ${missing_deps[*]}"
		log_error "Please install the avahi-utils package and iproute2 package."
		exit 1
	fi
}

validate_interface() {
	local interface="$1"

	if ! ip link show "$interface" &>/dev/null; then
		log_error "Network interface '$interface' not found."
		log_error "Available interfaces:"
		ip link show | grep -E '^[0-9]+:' | awk -F': ' '{print "  " $2}' | sed 's/@.*//' >&2
		exit 1
	fi
}

get_interface_addresses() {
	local interface="$1"
	local addresses

	addresses=$(ip -o addr show dev "$interface" scope global | awk '{print $4}' | cut -d/ -f1)

	if [[ -z "$addresses" ]]; then
		log_error "No global addresses found on interface '$interface'."
		exit 1
	fi

	echo "$addresses"
}

publish_addresses() {
	local fqdn="$1"
	local addresses="$2"
	local pids=()

	log_info "Publishing '$fqdn' with addresses:"

	for addr in $addresses; do
		log_info "  $addr"
		avahi-publish -f -a -R "$fqdn" "$addr" &
		pids+=($!)
	done

	# Wait for all background processes
	for pid in "${pids[@]}"; do
		wait "$pid"
	done
}

cleanup() {
	log_info "Cleaning up..."
	kill 0 2>/dev/null || true
}

main() {
	local interface="$DEFAULT_INTERFACE"

	# Parse command line options
	while getopts ":i:h" opt; do
		case "$opt" in
		i) interface="$OPTARG" ;;
		h)
			show_usage
			exit 0
			;;
		\?)
			log_error "Invalid option -$OPTARG"
			show_usage
			exit 1
			;;
		:)
			log_error "Option -$OPTARG requires an argument"
			show_usage
			exit 1
			;;
		esac
	done
	shift $((OPTIND - 1))

	# Validate arguments
	if [[ $# -ne 1 ]]; then
		log_error "Exactly one subdomain argument is required."
		show_usage
		exit 1
	fi

	local subdomain="$1"
	local fqdn="${subdomain}.$(hostname).local"

	# Check dependencies
	check_dependencies

	# Validate interface
	validate_interface "$interface"

	# Get addresses
	local addresses
	addresses=$(get_interface_addresses "$interface")

	# Set up cleanup trap
	trap cleanup SIGINT SIGTERM EXIT

	# Publish addresses
	publish_addresses "$fqdn" "$addresses"
}

main "$@"
